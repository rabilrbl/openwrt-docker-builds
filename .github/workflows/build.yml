name: Build Latest Docker for OpenWrt

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version (e.g., "snapshot" or "24.10.0")'
        required: true
        default: 'snapshot'
      target:
        description: 'Target Architecture'
        required: true
        default: 'bcm27xx/bcm2712'

  schedule:
    - cron: '0 0 * * 5'  # Weekly on Fridays

env:
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'snapshot' }}
  TARGET: ${{ github.event.inputs.target || 'bcm27xx/bcm2712' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 qemu-utils zstd

      - name: Resolve SDK URL
        id: sdk_config
        run: |
          if [ "${{ env.OPENWRT_VERSION }}" == "snapshot" ]; then
            BASE_URL="https://downloads.openwrt.org/snapshots/targets/${{ env.TARGET }}/"
          else
            BASE_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ env.TARGET }}/"
          fi
          
          echo "Looking for SDK in: $BASE_URL"
          
          # Fetch with retries
          SDK_FILE=$(curl -sL --retry 3 "$BASE_URL" | grep -o 'href="openwrt-sdk-[^"]*Linux-x86_64.tar\.[a-z]*"' | cut -d'"' -f2 | head -n 1 || true)
          
          if [ -z "$SDK_FILE" ]; then
            echo "::error::Could not find SDK file at $BASE_URL. Check the target/version."
            exit 1
          fi

          echo "Found SDK: $SDK_FILE"
          echo "url=${BASE_URL}${SDK_FILE}" >> $GITHUB_OUTPUT
          echo "filename=$SDK_FILE" >> $GITHUB_OUTPUT

      - name: Download and Setup SDK
        run: |
          wget -O sdk.archive ${{ steps.sdk_config.outputs.url }}
          mkdir sdk
          tar -I zstd -xf sdk.archive -C sdk --strip-components=1
          
          cd sdk
          # Disable signature check to avoid "signature check failed" errors on snapshots
          sed -i 's/option check_signature/# option check_signature/' feeds.conf.default

      - name: Configure Git
        run: |
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999

      - name: Update Feeds
        working-directory: ./sdk
        run: |
          # Retry logic for feeds update
          MAX_ATTEMPTS=5
          DELAY=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS: Updating feeds..."
            if ./scripts/feeds update -a; then
              echo "Feeds update successful!"
              break
            else
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "::error::Failed to update feeds after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              echo "::warning::Feeds update failed, retrying in $DELAY seconds..."
              sleep $DELAY
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          ./scripts/feeds install -a -p packages

      - name: Automate Version Updates
        working-directory: ./sdk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # CRITICAL: Prevents Rate Limiting
        run: |
          # Function to safely fetch tags using the Token
          get_latest_tag() {
             curl -H "Authorization: token $GH_TOKEN" -s "https://api.github.com/repos/$1/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo ""
          }
          
          get_commit_hash() {
             curl -H "Authorization: token $GH_TOKEN" -s "https://api.github.com/repos/$1/git/ref/tags/$2" | grep '"sha":' | sed -E 's/.*"([^"]+)".*/\1/' || echo ""
          }

          update_makefile() {
            PKG_NAME=$1
            NEW_VERSION=$2
            NEW_HASH=$3
            MAKEFILE=$4
            
            if [ -z "$NEW_VERSION" ] || [ -z "$NEW_HASH" ]; then
                echo "::warning::Skipping $PKG_NAME update (Failed to fetch version/hash)"
                return
            fi
            
            echo "Updating $PKG_NAME -> $NEW_VERSION ($NEW_HASH)"
            
            sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$NEW_VERSION/" $MAKEFILE
            sed -i "s/^PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=$NEW_HASH/" $MAKEFILE
            sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" $MAKEFILE
            
            # Clear old hashes
            sed -i "/^PKG_MIRROR_HASH:=/d" $MAKEFILE
            sed -i "/^PKG_HASH:=/d" $MAKEFILE
            
            # Disable Go Mod Hash Check
            sed -i "/^GO_PKG_ENABLE_MOD_DOWNLOAD_CHECK/d" $MAKEFILE
            echo "GO_PKG_ENABLE_MOD_DOWNLOAD_CHECK:=0" >> $MAKEFILE
          }

          # --- 1. GET DATA ---
          echo "Fetching latest Moby (Dockerd) version..."
          RAW_TAG=$(get_latest_tag "moby/moby")
          CLEAN_VERSION=$(echo $RAW_TAG | sed -E 's/^(docker-|v)//')
          MOBY_HASH=$(get_commit_hash "moby/moby" "$RAW_TAG")
          
          echo "Fetching Docker CLI hash..."
          CLI_TAG="v$CLEAN_VERSION"
          CLI_HASH=$(get_commit_hash "docker/cli" "$CLI_TAG")
          # Fallback if tag naming differs
          if [ -z "$CLI_HASH" ]; then 
             CLI_HASH=$(get_commit_hash "docker/cli" "$CLEAN_VERSION")
          fi
          
          echo "Fetching Containerd version..."
          CT_TAG=$(get_latest_tag "containerd/containerd")
          CT_VERSION=${CT_TAG#v}
          CT_HASH=$(get_commit_hash "containerd/containerd" "$CT_TAG")

          # --- 2. UPDATE MAKEFILES ---
          update_makefile "dockerd" "$CLEAN_VERSION" "$MOBY_HASH" "feeds/packages/utils/dockerd/Makefile"
          update_makefile "docker" "$CLEAN_VERSION" "$CLI_HASH" "feeds/packages/utils/docker/Makefile"
          update_makefile "containerd" "$CT_VERSION" "$CT_HASH" "feeds/packages/utils/containerd/Makefile"

      - name: Install Updated Packages
        working-directory: ./sdk
        run: |
          ./scripts/feeds install docker dockerd containerd

      - name: Compile Packages
        working-directory: ./sdk
        run: |
          make defconfig
          
          # IGNORE_ERRORS=1 is safer for automated builds
          echo "Compiling containerd..."
          make package/containerd/compile V=s || echo "::warning::Containerd build failed"
          
          echo "Compiling dockerd..."
          make package/dockerd/compile V=s || echo "::warning::Dockerd build failed"
          
          echo "Compiling docker..."
          make package/docker/compile V=s || echo "::warning::Docker build failed"

      - name: Collect Artifacts
        run: |
          mkdir -p output
          find sdk/bin/packages -name "docker*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "dockerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "containerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "runc*.ipk" -exec cp {} output/ \;

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: "docker-${{ env.OPENWRT_VERSION }}-${{ github.run_number }}"
          name: "Docker ${{ env.OPENWRT_VERSION }} (Build ${{ github.run_number }})"
          files: output/*.ipk
          body: |
             **OpenWrt Version:** ${{ env.OPENWRT_VERSION }}
             **Target:** ${{ env.TARGET }}
             **SDK:** ${{ steps.sdk_config.outputs.filename }}
