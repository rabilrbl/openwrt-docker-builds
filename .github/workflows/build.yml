name: Build Latest Docker for OpenWrt

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version (e.g., "snapshot" or "24.10.0")'
        required: true
        default: 'snapshot'
      target:
        description: 'Target Architecture'
        required: true
        default: 'bcm27xx/bcm2712'

  schedule:
    - cron: '0 0 * * 5'  # Weekly on Fridays

env:
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'snapshot' }}
  TARGET: ${{ github.event.inputs.target || 'bcm27xx/bcm2712' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # Added 'jq' for reliable JSON parsing and 'coreutils' for hash utilities (md5sum, sha256sum)
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 qemu-utils zstd jq coreutils

      - name: Resolve SDK URL
        id: sdk_config
        run: |
          if [ "${{ env.OPENWRT_VERSION }}" == "snapshot" ]; then
            BASE_URL="https://downloads.openwrt.org/snapshots/targets/${{ env.TARGET }}/"
          else
            BASE_URL="https://downloads.openwrt.org/releases/${{ env.OPENWRT_VERSION }}/targets/${{ env.TARGET }}/"
          fi
          
          SDK_FILE=$(curl -sL --retry 3 "$BASE_URL" | grep -o 'href="openwrt-sdk-[^"]*Linux-x86_64.tar\.[a-z]*"' | cut -d'"' -f2 | head -n 1 || true)
          
          if [ -z "$SDK_FILE" ]; then
            echo "::error::Could not find SDK file at $BASE_URL"
            exit 1
          fi

          echo "url=${BASE_URL}${SDK_FILE}" >> $GITHUB_OUTPUT
          echo "filename=$SDK_FILE" >> $GITHUB_OUTPUT

      - name: Cache SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: sdk
          key: ${{ runner.os }}-openwrt-sdk-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}-${{ steps.sdk_config.outputs.filename }}
          restore-keys: |
            ${{ runner.os }}-openwrt-sdk-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}-

      - name: Download and Setup SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          wget -O sdk.archive ${{ steps.sdk_config.outputs.url }}
          mkdir sdk
          tar -I zstd -xf sdk.archive -C sdk --strip-components=1
          cd sdk
          sed -i 's/option check_signature/# option check_signature/' feeds.conf.default

      - name: Configure Git for large repositories
        run: |
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999  # Effectively disable timeout

      - name: Cache Feeds
        uses: actions/cache@v4
        with:
          path: sdk/feeds
          key: ${{ runner.os }}-openwrt-feeds-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}
          restore-keys: |
            ${{ runner.os }}-openwrt-feeds-${{ env.OPENWRT_VERSION }}-

      - name: Update and install feeds with retry
        working-directory: ./sdk
        run: |
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if ./scripts/feeds update -a; then
              echo "Feed update successful"
              if ./scripts/feeds install -a -p packages; then
                echo "Feed install successful"
                exit 0
              else
                echo "Feed install failed"
              fi
            else
              echo "Feed update failed"
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "Failed after $max_attempts attempts"
              exit 1
            fi
            
            echo "Retrying in 10 seconds..."
            attempt=$((attempt+1))
            sleep 10
          done

      - name: Automate Version Updates
        working-directory: ./sdk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- HELPER FUNCTIONS ---
          get_latest_tag() {
             # Uses jq for safe parsing
             curl -H "Authorization: token $GH_TOKEN" -s "https://api.github.com/repos/$1/releases/latest" | jq -r .tag_name
          }
          
          get_commit_hash() {
             curl -H "Authorization: token $GH_TOKEN" -s "https://api.github.com/repos/$1/git/ref/tags/$2" | jq -r .object.sha
          }

          # Robust version cleaner: strips 'docker-', 'v', etc. recursively
          clean_version() {
             local v=$1
             # Remove 'docker-' prefix if present
             v=${v#docker-}
             # Remove 'v' prefix if present
             v=${v#v}
             echo "$v"
          }

          update_makefile() {
            PKG_NAME=$1
            NEW_VERSION=$2
            NEW_HASH=$3
            MAKEFILE=$4
            NEW_REF=$5
            
            echo "----------------------------------------"
            echo "Updating $PKG_NAME to $NEW_VERSION"
            echo "Hash: $NEW_HASH"
            if [ -n "$NEW_REF" ]; then
               echo "Ref: $NEW_REF"
            fi
            
            # Update Version and Source Hash
            sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$NEW_VERSION/" $MAKEFILE
            sed -i "s/^PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=$NEW_HASH/" $MAKEFILE
            sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" $MAKEFILE
            
            # Update Git Ref if provided (for special tags like docker-v*)
            if [ -n "$NEW_REF" ]; then
                if grep -q "^PKG_GIT_REF:=" $MAKEFILE; then
                     sed -i "s|^PKG_GIT_REF:=.*|PKG_GIT_REF:=$NEW_REF|" $MAKEFILE
                else
                     # If the variable doesn't exist, we might want to verify why, 
                     # but for now, we assume it exists as per our research or we append it?
                     # Safest is sed replacement if it exists. Re-check context: dockerd Makefile has PKG_GIT_REF.
                     :
                fi
            fi
          }

          # --- 1. GET DATA ---
          # Dockerd (Moby)
          RAW_MOBY_TAG=$(get_latest_tag "moby/moby")
          CLEAN_VERSION=$(clean_version "$RAW_MOBY_TAG")
          MOBY_HASH=$(get_commit_hash "moby/moby" "$RAW_MOBY_TAG")
          
          # Docker CLI (Match version with Moby)
          # We try v27.x.x first
          CLI_TAG="v$CLEAN_VERSION"
          CLI_HASH=$(get_commit_hash "docker/cli" "$CLI_TAG")
          
          # Containerd
          # RAW_CT_TAG=$(get_latest_tag "containerd/containerd")
          # CT_VERSION=$(clean_version "$RAW_CT_TAG")
          # CT_HASH=$(get_commit_hash "containerd/containerd" "$RAW_CT_TAG")

          echo "Detected Versions:"
          echo "  Docker/Moby: $CLEAN_VERSION"
          # echo "  Containerd:  $CT_VERSION"

          # --- 2. UPDATE MAKEFILES ---
          # Pass RAW_MOBY_TAG (e.g. docker-v29.1.4) as the custom ref for dockerd
          update_makefile "dockerd" "$CLEAN_VERSION" "$MOBY_HASH" "feeds/packages/utils/dockerd/Makefile" "$RAW_MOBY_TAG"
          
          # Docker CLI uses standard vPrefix, so default ref handling in Makefile (v$PKG_VERSION) works
          update_makefile "docker" "$CLEAN_VERSION" "$CLI_HASH" "feeds/packages/utils/docker/Makefile"
          # update_makefile "containerd" "$CT_VERSION" "$CT_HASH" "feeds/packages/utils/containerd/Makefile"

      - name: Register Packages
        working-directory: ./sdk
        run: |
          ./scripts/feeds install docker dockerd containerd runc

      - name: Cache Build Artifacts
        uses: actions/cache@v4
        with:
          path: |
            sdk/build_dir
            sdk/staging_dir
            sdk/dl
          key: ${{ runner.os }}-openwrt-build-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-openwrt-build-${{ env.OPENWRT_VERSION }}-${{ env.TARGET }}-
            ${{ runner.os }}-openwrt-build-${{ env.OPENWRT_VERSION }}-

      - name: Compile Packages
        working-directory: ./sdk
        run: |
          make defconfig
          
          echo "::group::Compile Containerd"
          make package/containerd/compile V=s
          echo "::endgroup::"
          
          echo "::group::Compile Dockerd"
          make package/dockerd/compile V=s
          echo "::endgroup::"
          
          echo "::group::Compile Docker CLI"
          make package/docker/compile V=s
          echo "::endgroup::"

      - name: Collect Artifacts
        run: |
          mkdir -p output
          find sdk/bin/packages -name "docker*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "dockerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "containerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "runc*.ipk" -exec cp {} output/ \;

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: "docker-${{ env.OPENWRT_VERSION }}-${{ github.run_number }}"
          name: "Docker ${{ env.OPENWRT_VERSION }} (Build ${{ github.run_number }})"
          files: output/*.ipk
          body: |
             **Target:** ${{ env.TARGET }}
             **Components:**
             * Docker/Dockerd
             * Containerd
             * Runc
