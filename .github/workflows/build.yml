name: Build Latest Docker for OpenWrt

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 5'  # Weekly on Fridays

env:
  TARGET_URL: https://downloads.openwrt.org/snapshots/targets/bcm27xx/bcm2712/

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 qemu-utils zstd

      - name: Resolve Dynamic SDK URL
        id: sdk
        run: |
          # 1. Fetch the HTML listing
          # 2. Grep for the SDK file (looking for 'openwrt-sdk' and 'Linux-x86_64')
          # 3. Extract just the filename
          SDK_FILE=$(curl -sL ${{ env.TARGET_URL }} | grep -o 'href="openwrt-sdk-[^"]*Linux-x86_64.tar.[a-z]*"' | cut -d'"' -f2 | head -n 1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "::error::Could not find SDK file in ${{ env.TARGET_URL }}"
            exit 1
          fi

          echo "Found SDK: $SDK_FILE"
          echo "url=${{ env.TARGET_URL }}${SDK_FILE}" >> $GITHUB_OUTPUT
          echo "filename=$SDK_FILE" >> $GITHUB_OUTPUT

      - name: Download and Setup OpenWrt SDK
        run: |
          wget -O sdk.archive ${{ steps.sdk.outputs.url }}
          
          mkdir sdk
          # Handle both .tar.xz and .tar.zst automatically
          tar -I zstd -xf sdk.archive -C sdk --strip-components=1
          
          cd sdk
          # Disable signature checks for CI
          sed -i 's/option check_signature/# option check_signature/' feeds.conf.default

      - name: Update Feeds & Locate Packages
        working-directory: ./sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a -p packages
          
          # Verify paths
          ls -d feeds/packages/utils/docker
          ls -d feeds/packages/utils/dockerd
          ls -d feeds/packages/utils/containerd

      - name: Automate Version Updates
        working-directory: ./sdk
        run: |
          update_package() {
            PKG_NAME=$1
            REPO=$2
            MAKEFILE_PATH=$3
            
            echo "Updating $PKG_NAME..."
            
            # Fetch Latest Tag
            LATEST_TAG=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
            VERSION=${LATEST_TAG#v}
            
            # Fetch Commit Hash
            COMMIT_HASH=$(curl -s "https://api.github.com/repos/$REPO/git/ref/tags/$LATEST_TAG" | grep '"sha":' | sed -E 's/.*"([^"]+)".*/\1/')
            
            echo "  Version: $VERSION"
            echo "  Hash: $COMMIT_HASH"
            
            # Apply Changes
            sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$VERSION/" $MAKEFILE_PATH
            sed -i "s/^PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=$COMMIT_HASH/" $MAKEFILE_PATH
            sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" $MAKEFILE_PATH
            
            # Remove old checksums to force re-verification
            sed -i "/^PKG_MIRROR_HASH:=/d" $MAKEFILE_PATH
            sed -i "/^PKG_HASH:=/d" $MAKEFILE_PATH
            
            # FIX: Disable Go Module Hash Check (Prevents build failure on version bump)
            sed -i "/^GO_PKG_ENABLE_MOD_DOWNLOAD_CHECK/d" $MAKEFILE_PATH
            echo "GO_PKG_ENABLE_MOD_DOWNLOAD_CHECK:=0" >> $MAKEFILE_PATH
          }

          update_package "docker" "docker/cli" "feeds/packages/utils/docker/Makefile"
          update_package "dockerd" "moby/moby" "feeds/packages/utils/dockerd/Makefile"
          update_package "containerd" "containerd/containerd" "feeds/packages/utils/containerd/Makefile"

      - name: Install Updated Packages
        working-directory: ./sdk
        run: |
          ./scripts/feeds install docker dockerd containerd

      - name: Compile Packages
        working-directory: ./sdk
        run: |
          make defconfig
          
          # Build in dependency order
          make package/containerd/compile V=s
          make package/dockerd/compile V=s
          make package/docker/compile V=s

      - name: Collect Artifacts
        run: |
          mkdir -p output
          find sdk/bin/packages -name "docker*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "dockerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "containerd*.ipk" -exec cp {} output/ \;
          find sdk/bin/packages -name "runc*.ipk" -exec cp {} output/ \;

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: "weekly-${{ github.run_number }}"
          name: "Weekly Docker Build (Pi 5)"
          files: output/*.ipk
          body: |
             Target: Raspberry Pi 5 (bcm27xx/bcm2712)
             SDK: ${{ steps.sdk.outputs.filename }}
